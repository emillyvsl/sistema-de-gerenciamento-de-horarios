{% extends 'base.html' %}
{% load static %}

{% block title %}
  Horários do Curso
{% endblock %}

{% block content %}
  <div class="container mb-10">
    <!-- Botão para adicionar horário que abre o modal -->
    <div class="text-right mb-4">
      <a href="#" class="btn btn-primary" data-toggle="modal" data-target="#modalAdicionarHorario">Adicionar Horário</a>
    </div>

    <!-- Tabela de horários por dia da semana -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Dia da Semana</th>
          <th>Horários</th>
        </tr>
      </thead>
      <tbody>
        {% for dia, horarios in horarios_por_dia.items %}
          <tr>
            <td>{{ dia }}</td>
            <td>
              <ul class="list-unstyled">
                {% for horario in horarios %}
                  <li>
                    {{ horario.hora_inicio }} - {{ horario.hora_fim }}
                    <!-- Botão para abrir modal de edição -->
                    <button class="btn btn-sm btn-primary" 
                            data-toggle="modal" 
                            data-target="#modalEditarHorario"
                            data-id="{{ horario.id }}"
                            data-dia-semana="{{ dia }}"  <!-- Adicione o dia da semana -->
                            data-hora-inicio="{{ horario.hora_inicio }}"
                            data-hora-fim="{{ horario.hora_fim }}">
                      Editar
                    </button>

                    <!-- Formulário para excluir o horário -->
                    <form method="POST" action="{% url 'horarios_excluir' horario.id %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal para adicionar horário -->
  <div class="modal fade" id="modalAdicionarHorario" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">Adicionar Horário</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <form method="POST" action="{% url 'horarios_adicionar' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="form-group">
              <label for="dias_semana">Dias da Semana</label>
              <div class="form-check">
                {% for dia in dias %}
                  <input class="form-check-input" type="checkbox" id="dia_{{ dia.id }}" name="dias_semana" value="{{ dia.id }}" />
                  <label class="form-check-label" for="dia_{{ dia.id }}">{{ dia.nome }}</label><br />
                {% endfor %}
              </div>
            </div>
            <div id="horarios-container">
              <div class="form-group">
                <label for="hora_inicio">Hora de Início</label>
                <input type="time" class="form-control" id="hora_inicio" name="hora_inicio[]" required />
              </div>
              <div class="form-group">
                <label for="hora_fim">Hora de Fim</label>
                <input type="time" class="form-control" id="hora_fim" name="hora_fim[]" required />
              </div>
            </div>
            <button type="button" id="adicionar-horario" class="btn btn-secondary">Adicionar Mais Horários</button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para editar horário -->
  <div class="modal fade" id="modalEditarHorario" tabindex="-1" role="dialog" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel">Editar Horário</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <form id="formEditarHorario" method="POST">
          {% csrf_token %}
          <div class="modal-body">
            <div class="form-group">
              <label for="hora_inicio_editar">Hora de Início</label>
              <input type="time" class="form-control" id="hora_inicio_editar" name="hora_inicio" required />
            </div>
            <div class="form-group">
              <label for="hora_fim_editar">Hora de Fim</label>
              <input type="time" class="form-control" id="hora_fim_editar" name="hora_fim" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Configura o modal com os dados do horário ao clicar em "Editar"
    $('#modalEditarHorario').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget); // Botão que acionou o modal
      var horarioId = button.data('id');
      var horaInicio = button.data('hora-inicio');
      var horaFim = button.data('hora-fim');
      var diaSemana = button.data('dia-semana'); // Adicione o dia da semana

      // Atualiza os valores do modal com os dados do horário
      var modal = $(this);
      modal.find('#hora_inicio_editar').val(horaInicio);
      modal.find('#hora_fim_editar').val(horaFim);

      // Atualiza o action do formulário de edição
      var form = modal.find('#formEditarHorario');
      form.attr('action', '/horarios/editar/' + horarioId + '/');
    });
  </script>
{% endblock %}
