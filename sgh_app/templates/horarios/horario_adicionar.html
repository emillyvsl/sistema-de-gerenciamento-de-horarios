{% extends 'base.html' %}
{% load static %}

{% block title %}
  Horários do Curso
{% endblock %}

{% block content %}
  <div class="container margin-top">
    <!-- Botão para adicionar horário que abre o modal -->
    <div class="text-right mb-4">
      <a href="#" class="btn btn-primary" data-toggle="modal" data-target="#modalAdicionarHorario">Adicionar Horário</a>
    </div>

    <!-- Tabela de horários -->
    <table class="table table-borderless">
      <thead>
        <tr>
          <th scope="col">Horário</th>
          <th scope="col">Dias da Semana</th>
          <th scope="col">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for horario in horarios_curso %}
          <tr>
            <td>{{ horario.hora_inicio }} a {{ horario.hora_fim }}</td>
            <td>
              {% for dia in horario.dias_semana.all %}
                {{ dia.nome }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </td>
            <td>
              <!-- Botão para abrir o modal de edição -->
              <button class="btn btn-warning btn-sm" data-horario-id="{{ horario.id }}" data-hora-inicio="{{ horario.hora_inicio }}" data-hora-fim="{{ horario.hora_fim }}" onclick="abrirModalEditar(this)">Editar</button>
    
              <!-- Formulário para excluir horário -->
              <form action="{% url 'horarios_excluir' horario.id %}" method="POST" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal para adicionar horário -->
  <div class="modal fade" id="modalAdicionarHorario" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">Adicionar Horário</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <form method="POST" action="{% url 'horarios_adicionar' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="form-group">
              <label for="dias_semana">Dias da Semana</label>
              <select class="form-control" id="dias_semana" name="dias_semana" multiple>
                {% for dia in dias %}
                  <option value="{{ dia.id }}">{{ dia.nome }}</option>
                {% endfor %}
              </select>
              <small class="form-text text-muted">Segure Ctrl (ou Cmd no Mac) para selecionar múltiplos dias.</small>
            </div>
            <div class="form-group">
              <label for="hora_inicio">Hora de Início</label>
              <input type="time" class="form-control" id="hora_inicio" name="hora_inicio" required />
            </div>
            <div class="form-group">
              <label for="hora_fim">Hora de Fim</label>
              <input type="time" class="form-control" id="hora_fim" name="hora_fim" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para editar horário -->
  <div class="modal fade" id="modalEditarHorario" tabindex="-1" role="dialog" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel">Editar Horário</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <form method="POST" id="formEditarHorario">
          {% csrf_token %}
          <div class="modal-body">
            <input type="hidden" id="editarHorarioId" name="horario_id" />
            <div class="form-group">
              <label for="editarHoraInicio">Hora de Início</label>
              <input type="time" class="form-control" id="editarHoraInicio" name="hora_inicio" required />
            </div>
            <div class="form-group">
              <label for="editarHoraFim">Hora de Fim</label>
              <input type="time" class="form-control" id="editarHoraFim" name="hora_fim" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function abrirModalEditar(button) {
      // Pegar os dados do botão de edição
      var horarioId = button.getAttribute('data-horario-id');
      var horaInicio = button.getAttribute('data-hora-inicio');
      var horaFim = button.getAttribute('data-hora-fim');

      // Preencher o modal com os valores
      document.getElementById('editarHorarioId').value = horarioId;
      document.getElementById('editarHoraInicio').value = horaInicio;
      document.getElementById('editarHoraFim').value = horaFim;

      // Abrir o modal
      var modal = new bootstrap.Modal(document.getElementById('modalEditarHorario'));
      modal.show();
    }

    // Redirecionar o form para o URL correto ao submeter
    document.getElementById('formEditarHorario').addEventListener('submit', function (event) {
      event.preventDefault(); // Evitar o envio padrão
      var horarioId = document.getElementById('editarHorarioId').value;
      this.action = '/horarios/editar/' + horarioId + '/'; // Definir o action do form
      this.submit(); // Submeter o form
    });
  </script>
{% endblock %}
